// ==UserScript==
// @name        simple-fmc-gefs-plugin
// @namespace   andermatt64-gefs-plugins
// @version     0.0.1
// @description Simple FMC GEFS Plugin
// @author      andermatt64
// @match       http://*.gefs-online.com/gefs.php
// @grant       none
// ==/UserScript==

var APS={mode:"HOLD",content:null,init:function(a){APS.content=a}},SimpleFMC={timerID:null,updateFnList:[],init:function(){Log.init(UI.logContainer),Status.init(UI.statusContainer),APS.init(UI.apsContainer),Route.init(UI.routeContainer),Info.init(UI.infoContainer),SimpleFMC.timerID=setInterval(SimpleFMC.backgroundUpdate,1e3),Log.info("SimpleFMC initialized and ready to go.")},registerUpdate:function(a){SimpleFMC.updateFnList.push(a)},backgroundUpdate:function(){for(var a=0;a<SimpleFMC.updateFnList.length;a++)SimpleFMC.updateFnList[a]()},fini:function(){null!==SimpleFMC.timerID&&clearInterval(SimpleFMC.timerID)}},BANNER=" _____  _                    _       ______ ___  ___ _____  \n/  ___|(_)                  | |      |  ___||  \\/  |/  __ \\ \n\\ `--.  _  _ __ ___   _ __  | |  ___ | |_   | .  . || /  \\/ \n `--. \\| || '_ ` _ \\ | '_ \\ | | / _ \\|  _|  | |\\/| || |     \n/\\__/ /| || | | | | || |_) || ||  __/| |    | |  | || \\__/\\ \n\\____/ |_||_| |_| |_|| .__/ |_| \\___|\\_|    \\_|  |_/ \\____/ \n                     | |                                    \n                     |_|                                    \n",Info={content:null,_uptime:null,_aircraft:null,_mass:null,init:function(a){Info.content=a;var b=$("<pre></pre>");b.text(BANNER).css("margin-left","5px").css("line-height","1").css("font-size","8pt"),Info._aircraft=$("<span></span>"),Info._uptime=$("<span></span>"),Info._mass=$("<span></span>");var c=$("<span></span>");c.text("ASCII ART GENERATED BY ").append($('<a href="http://patorjk.com/software/taag">TaaG</a>'));var d=$("<div></div>");d.css("margin-left","5px").text("AIRCRAFT: ").append(Info._aircraft).append($("<br>")).append("WEIGHT: ").append(Info._mass).append($("<br>")).append("UPTIME: ").append(Info._uptime).append($("<br><br>")).append(c),Info.content.append(b).append(d),SimpleFMC.registerUpdate(Info.update)},update:function(){Info._aircraft.text(gefs.aircraft.name),Info._uptime.text(Log.uptime()),Info._mass.text(gefs.aircraft.rigidBody.mass+"KG")}},Log={content:null,startTime:null,init:function(a){Log.content=a,Log.content.css("overflow-y","scroll").css("overflow-x","auto").css("line-height","1.3").css("height","290px"),Log.startTime=Date.now()},info:function(a){Log._write(Log._entry("#9be651",a))},warning:function(a){Log._write(Log._entry("#ffc300",a))},error:function(a){Log._write(Log._entry("#d14537",a))},clear:function(){Log.content.empty()},uptime:function(){var a=parseInt((Date.now()-Log.startTime)/1e3),b=parseInt(a/3600).toString();1===b.length&&(b="0"+b);var c=parseInt(a%3600/60).toString();1===c.length&&(c="0"+c);var d=parseInt(a%3600%60).toString();return 1===d.length&&(d="0"+d),b+":"+c+":"+d},_entry:function(a,b){var c=$("<div></div>"),d=$("<span></span>");d.css("color","#0f0").css("font-size","8pt").css("margin-right","4px").text("["+Log.uptime()+"]");var e=$("<span></span>");return e.css("color",a).text(b),c.append(d).append(e),c},_write:function(a){Log.content.prepend(a)}};!function(){"use strict";var a=function(){UI.init(),SimpleFMC.init()},b=setInterval(function(){if(window.gefs&&gefs.init)if(clearInterval(b),gefs.canvas)a();else{var c=gefs.init;gefs.init=function(){c(),a()}}},16)}();var Route={content:null,init:function(a){Route.content=a}},makeStatusPanel=function(){var a=$("<div></div>");return a.css("width","25%").css("height","100px").css("float","left"),a},NextWaypoint={_panel:null,_fill:null,_time:null,_target:null,init:function(a){NextWaypoint._panel=makeStatusPanel();var b=$("<div></div>");b.css("margin-top","5px").css("margin-bottom","5px").css("margin-left","5px").css("border","1px solid #0f0").css("width","10px").css("height","80px").css("background","#0f0").css("float","left"),NextWaypoint._fill=$("<div></div>"),NextWaypoint._fill.css("background","#000").css("height","100%");var c=$("<div></div>");c.css("padding-top","5px").css("padding-left","5px").css("color","#0f0").css("float","left"),NextWaypoint._time=$("<span></span>"),NextWaypoint._target=$("<span></span>"),c.text("NEXT WPT").append($("<br>")).append(NextWaypoint._target).append($("<br>")).append("ETA").append($("<br>")).append(NextWaypoint._time),b.append(NextWaypoint._fill),NextWaypoint._panel.append(b).append(c),a.append(NextWaypoint._panel)},update:function(){}},ElevatorTrim={_panel:null,_fill:null,_trim:null,init:function(a){ElevatorTrim._panel=makeStatusPanel();var b=$("<div></div>");b.css("margin-top","5px").css("margin-bottom","5px").css("margin-left","5px").css("border","1px solid #0f0").css("width","10px").css("height","80px").css("background","#0f0").css("float","left"),ElevatorTrim._fill=$("<div></div>"),ElevatorTrim._fill.css("background","#000").css("height","100%");var c=$("<div></div>");c.css("padding-top","5px").css("padding-left","5px").css("color","#0f0").css("float","left"),ElevatorTrim._trim=$("<span></span>"),c.text("ELVTRIM").append($("<br>")).append(ElevatorTrim._trim),b.append(ElevatorTrim._fill),ElevatorTrim._panel.append(b).append(c),a.append(ElevatorTrim._panel)},update:function(a){var b=parseInt(100*(a+.5));ElevatorTrim._fill.css("height",(100-Math.abs(b)).toString()+"%"),ElevatorTrim._trim.text((parseInt(1e3*a)/1e3).toString())}},APStatus={_panel:null,_label:null,_mode:null,init:function(a){APStatus._panel=makeStatusPanel();var b=$("<div></div>");b.css("margin-left","5px").css("margin-top","5px"),APStatus._label=$("<span></span>"),APStatus._mode=$("<span></span>"),b.text("AP STAT").append($("<br>")).append(APStatus._label).append($("<br>")).append("AP MODE").append($("<br>")).append(APStatus._mode),APStatus._panel.append(b),a.append(APStatus._panel)},update:function(a,b){a?APStatus._label.text("ON").css("color","#339966"):APStatus._label.text("OFF").css("color","#ff3300"),APStatus._mode.text(b)}},Brakes={_panel:null,_airbrake:null,_brake:null,init:function(a){Brakes._panel=makeStatusPanel();var b=$("<div></div>");b.css("margin-left","5px").css("margin-top","5px"),Brakes._airbrake=$("<span></span>"),Brakes._brake=$("<span></span>"),b.text("SPOILER").append($("<br>")).append(Brakes._airbrake).append($("<br>")).append("BRAKES").append($("<br>")).append(Brakes._brake),Brakes._panel.append(b),a.append(Brakes._panel)},update:function(a,b){0===a?Brakes._airbrake.text("DISARM").css("color","#339966"):1===a?Brakes._airbrake.text("ARM").css("color","#ff3300"):Brakes._airbrake.text("CHNG").css("color","#ff9933"),0===b?Brakes._brake.text("OFF").css("color","#339966"):Brakes._brake.text("ON").css("color","#ff3300")}},AltitudeAndClimbRate={_panel:null,_altitudeLabel:null,_climbRateLabel:null,init:function(a){AltitudeAndClimbRate._panel=makeStatusPanel();var b=$("<div></div>");b.css("margin-left","5px").css("margin-top","5px"),AltitudeAndClimbRate._altitudeLabel=$("<span></span>"),AltitudeAndClimbRate._climbRateLabel=$("<span></span>"),b.text("ALTITUDE").append($("<br>")).append(AltitudeAndClimbRate._altitudeLabel).append($("<br>")).append("VERTSPD").append($("<br>")).append(AltitudeAndClimbRate._climbRateLabel),AltitudeAndClimbRate._panel.append(b),a.append(AltitudeAndClimbRate._panel)},update:function(a,b){a=parseInt(a).toString(),b=parseInt(b).toString(),AltitudeAndClimbRate._altitudeLabel.text(a+"FT"),AltitudeAndClimbRate._climbRateLabel.text(b+"FT/M")}},HeadingAndSpeed={_panel:null,_headingLabel:null,_speedLabel:null,init:function(a){HeadingAndSpeed._panel=makeStatusPanel();var b=$("<div></div>");b.css("margin-left","5px").css("margin-top","5px"),HeadingAndSpeed._headingLabel=$("<span></span>"),HeadingAndSpeed._speedLabel=$("<span></span>"),b.text("HEADING").append($("<br>")).append(HeadingAndSpeed._headingLabel).append($("<br>")).append("KIAS").append($("<br>")).append(HeadingAndSpeed._speedLabel),HeadingAndSpeed._panel.append(b),a.append(HeadingAndSpeed._panel)},update:function(a,b){a=parseInt(a).toString(),b=parseInt(b).toString(),HeadingAndSpeed._headingLabel.text(a+"DEG"),HeadingAndSpeed._speedLabel.text(b+"KTS")}},FlapsAndGear={_panel:null,_fill:null,_flapLabel:null,_gearLabel:null,init:function(a){FlapsAndGear._panel=makeStatusPanel();var b=$("<div></div>");b.css("margin-top","5px").css("margin-bottom","5px").css("margin-left","5px").css("border","1px solid #0f0").css("width","10px").css("height","80px").css("background","#0f0").css("float","left"),FlapsAndGear._fill=$("<div></div>"),FlapsAndGear._fill.css("background","#000").css("height","100%");var c=$("<div></div>");c.css("padding-top","5px").css("padding-left","5px").css("color","#0f0").css("float","left"),FlapsAndGear._flapLabel=$("<span></span>"),FlapsAndGear._gearLabel=$("<span></span>"),c.text("FLAPS").append($("<br>")).append(FlapsAndGear._flapLabel).append($("<br>")).append("GEAR").append($("<br>")).append(FlapsAndGear._gearLabel),b.append(FlapsAndGear._fill),FlapsAndGear._panel.append(b).append(c),a.append(FlapsAndGear._panel)},update:function(a,b){var c=parseInt(100*a);FlapsAndGear._fill.css("height",(100-Math.abs(c)).toString()+"%");var d=c.toString();1===d.length?d="00"+d:2===d.length&&(d="0"+d),FlapsAndGear._flapLabel.text(d+"/100"),0===b?FlapsAndGear._gearLabel.text("DOWN").css("color","#339966"):1===b?FlapsAndGear._gearLabel.text("UP").css("color","#ff3300"):FlapsAndGear._gearLabel.text("CHNG").css("color","#ff9933")}},Throttle={_panel:null,_fill:null,_label:null,_engine:null,_meter:null,init:function(a){Throttle._panel=makeStatusPanel(),Throttle._meter=$("<div></div>"),Throttle._meter.css("margin-top","5px").css("margin-bottom","5px").css("margin-left","5px").css("border","1px solid #0f0").css("width","10px").css("height","80px").css("background","#0f0").css("float","left"),Throttle._fill=$("<div></div>"),Throttle._fill.css("background","#000").css("height","100%");var b=$("<div></div>");b.css("padding-top","5px").css("padding-left","5px").css("color","#0f0").css("float","left"),Throttle._label=$("<span></span>"),Throttle._engine=$("<span></span>"),b.text("THROT").append($("<br>")).append(Throttle._label).append($("<br>")).append("ENGINE").append($("<br>")).append(Throttle._engine),Throttle._meter.append(Throttle._fill),Throttle._panel.append(Throttle._meter).append(b),a.append(Throttle._panel)},update:function(a,b){var c=parseInt(100*a);Throttle._fill.css("height",(100-Math.abs(c)).toString()+"%"),c<0?(c=-c,Throttle._meter.css("background","#ff8400"),Throttle._label.css("color","#ff8400")):(Throttle._meter.css("background","#0f0"),Throttle._label.css("color","#0f0"));var d=c.toString();1===d.length?d="00"+d:2===d.length&&(d="0"+d),Throttle._label.text(d+"/100"),b?Throttle._engine.css("color","#339966").text("ON"):Throttle._engine.css("color","#ff3300").text("OFF")}},Status={content:null,init:function(a){Status.content=a,Throttle.init(a),HeadingAndSpeed.init(a),AltitudeAndClimbRate.init(a),NextWaypoint.init(a),FlapsAndGear.init(a),ElevatorTrim.init(a),Brakes.init(a),APStatus.init(a),SimpleFMC.registerUpdate(function(){Throttle.update(gefs.aircraft.animationValue.throttle,gefs.aircraft.engine.on),HeadingAndSpeed.update(gefs.aircraft.animationValue.heading360,gefs.aircraft.animationValue.kias),AltitudeAndClimbRate.update(gefs.aircraft.animationValue.altitude,gefs.aircraft.animationValue.climbrate),FlapsAndGear.update(gefs.aircraft.animationValue.flapsValue,gefs.aircraft.animationValue.gearPosition),ElevatorTrim.update(gefs.aircraft.animationValue.trim),Brakes.update(gefs.aircraft.animationValue.airbrakesPosition,gefs.aircraft.animationValue.brakes),APStatus.update(controls.autopilot.on,APS.mode)})}},UI={FmcHeight:"300px",infoContainer:null,statusContainer:null,apsContainer:null,routeContainer:null,logContainer:null,init:function(){$(".gefs-map-list").css("border-bottom",UI.FmcHeight+" solid transparent");var a=$(".gefs-autopilot");a.empty().css("height",UI.FmcHeight).css("font-family","Lucida Console, Monaco, monospace").css("font-size","9pt").css("background","#555555").css("padding","0 0 0 0");var b=function(a,b){var c=$("<button></button>");return c.text(a).css("width","100%").css("font-family","Lucida Console, Monaco, monospace").css("font-weight","bold").css("font-size","8pt").css("text-align","left").css("transition-duration","0.4s").css("border-top","1px solid #000").css("border-left","1px solid #000"),void 0!==b&&b&&c.css("border-bottom","1px solid #000"),c},c=$("<div></div>");c.css("float","left").css("width","10%").css("margin-right","0px").css("padding-right","0px");var d=$("<div></div>");d.css("float","left").css("background","#000").css("color","#0f0").css("width","90%").css("height","300px").css("margin-right","0px").css("padding-right","0px"),UI.infoContainer=$("<div></div>"),UI.infoContainer.css("padding","5px"),UI.statusContainer=$("<div></div>"),UI.statusContainer.css("padding","5px"),UI.apsContainer=$("<div></div>"),UI.apsContainer.css("padding","5px"),UI.routeContainer=$("<div></div>"),UI.routeContainer.css("padding","5px"),UI.logContainer=$("<div></div>"),UI.logContainer.css("padding","5px");var e=b("INFO");e.click(function(){d.empty(),d.append(UI.infoContainer)});var f=b("STAT");f.click(function(){d.empty(),d.append(UI.statusContainer)});var g=b("APS");g.click(function(){d.empty(),d.append(UI.apsContainer)});var h=b("RTE");h.click(function(){d.empty(),d.append(UI.routeContainer)});var i=b("LOG",!0);i.click(function(){d.empty(),d.append(UI.logContainer)}),d.append(UI.infoContainer),c.append(e).append(f).append(g).append(h).append(i),a.append(c).append(d)}},Utils={toRadians:function(a){return a*(Math.PI/180)},toDegrees:function(a){return a*(180/Math.PI)},getGreatCircleBearing:function(a,b){var c=Utils.toRadians(a.lat),d=Utils.toRadians(a.lon),e=Utils.toRadians(b.lat),f=Utils.toRadians(b.lon),g=Math.sin(f-d)*Math.cos(e),h=Math.cos(c)*Math.sin(e)-Math.sin(c)*Math.cos(e)*Math.cos(f-d),i=Math.atan2(g,h);return(Utils.toDegrees(i)+360)%360},getGreatCircleDistance:function(a,b){var c=6371e3,d=Utils.toRadians(a.lat),e=Utils.toRadians(b.lat),f=Utils.toRadians(b.lat-a.lat),g=Utils.toRadians(b.lon-a.lon),h=Math.sin(f/2)*Math.sin(f/2)+Math.cos(d)*Math.cos(e)*Math.sin(g/2)*Math.sin(g/2),i=2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)),j=c*i;return j/1e3}};