// ==UserScript==
// @name        simple-fmc-gefs-plugin
// @namespace   andermatt64-gefs-plugins
// @version     0.0.1
// @description Simple FMC GEFS Plugin
// @author      andermatt64
// @require     https://raw.githubusercontent.com/andermatt64/simple-fmc-gefs-plugin/master/dist/simple-fmc-gefs-plugin-locations.min.js
// @match       http://*.gefs-online.com/gefs.php
// @grant       none
// ==/UserScript==

var APS={mode:"HDG",content:null,apBtn:null,hdgBtn:null,rteBtn:null,hptBtn:null,hdrLabel:null,altLabel:null,iasLabel:null,nextLabel:null,distLabel:null,etaLabel:null,_holdPatternTicks:0,_lastDistance:null,_holdPatternCoord:[],init:function(a){APS.content=a;var b=function(a){var b=$("<div></div>");return b.css("float","left").css("width","calc(25% - 4px)").css("height","50px").css("padding","2px").append(a),b},c=function(){var a=$("<button></button>");return a.css("width","100%").css("height","50px").css("background","#000").css("color","#f00").css("border","1px solid #f00"),a},d=function(a){var b=$("<div></div>");return b.css("float","left").css("width","calc(33.33333% - 4px)").css("height","50px").css("padding","2px"),void 0!==a&&a&&b.css("text-align","center"),b},e=function(){var a=$("<div></div>");return a.css("float","left").css("width","100%").css("height","10px"),a},f=function(a){var b=$("<input></input>");return b.attr("type","text").attr("size",a).attr("maxlength",a).css("background","#000").css("color","#fff").css("border","0px").css("font-family",'"Lucida Console", Monaco, monospace').css("font-size","10pt"),b};APS.apBtn=c(),APS.apBtn.text("AUTOPILOT\nDISENGAGED").click(function(){controls.autopilot.on?APS.turnOff():APS.turnOn()}),APS.hdgBtn=c(),APS.rteBtn=c(),APS.hptBtn=c(),APS.hdgBtn.text("HDG").css("color","#0f0").css("border","1px solid #0f0").click(function(){APS.hdgBtn.css("color","#0f0").css("border","1px solid #0f0"),APS.rteBtn.css("color","#f00").css("border","1px solid #f00"),APS.hptBtn.css("color","#f00").css("border","1px solid #f00"),APS.mode="HDG",APS.hdgLabel.prop("disabled",!1)}),APS.rteBtn.text("ROUTE").click(function(){APS.rteBtn.css("color","#0f0").css("border","1px solid #0f0"),APS.hdgBtn.css("color","#f00").css("border","1px solid #f00"),APS.hptBtn.css("color","#f00").css("border","1px solid #f00"),APS.mode="RTE",APS.hdgLabel.prop("disabled",!0)}),APS.hptBtn.text("HLDPAT").click(function(){APS.hptBtn.css("color","#0f0").css("border","1px solid #0f0"),APS.rteBtn.css("color","#f00").css("border","1px solid #f00"),APS.hdgBtn.css("color","#f00").css("border","1px solid #f00"),APS.mode="HPT",APS.hdgLabel.prop("disabled",!0),APS._initHoldPattern()});var g=d(!0);APS.hdgLabel=f(3),APS.hdgLabel.keypress(function(a){13===a.keyCode&&APS.hdgLabel.blur()}).blur(function(){if(controls.autopilot.on&&"HDG"===APS.mode){var a=parseInt(APS.hdgLabel.val());!isNaN(a)&&a>=0&&a<=360?controls.autopilot.setHeading(a%360):APS.hdgLabel.val(parseInt(gefs.aircraft.animationValue.heading360))}}),g.text("HDG").append($("<br>")).append(APS.hdgLabel).append("DEG");var h=d(!0);APS.altLabel=f(5),APS.altLabel.keypress(function(a){13===a.keyCode&&APS.altLabel.blur()}).blur(function(){if(controls.autopilot.on){var a=parseInt(APS.altLabel.val());isNaN(a)?APS.altLabel.val(parseInt(gefs.aircraft.animationValue.altitude)):controls.autopilot.setAltitude(a)}}),h.text("ALT").append($("<br>")).append(APS.altLabel).append("FT");var i=d(!0);APS.iasLabel=f(3),APS.iasLabel.keypress(function(a){13===a.keyCode&&APS.iasLabel.blur()}).blur(function(){if(controls.autopilot.on){var a=parseInt(APS.iasLabel.val());!isNaN(a)&&a>0?controls.autopilot.setKias(a):APS.iasLabel.val(parseInt(gefs.aircraft.animationValue.kias))}}),i.text("IAS").append($("<br>")).append(APS.iasLabel).append("KTS");var j=d();APS.nextLabel=$("<span></span>"),j.text("NEXT WAYPT").append($("<br>")).append(APS.nextLabel);var k=d();APS.distLabel=$("<span></span>"),k.text("DIST").append($("<br>")).append(APS.distLabel);var l=d();APS.etaLabel=$("<span></span>"),l.text("ETA").append($("<br>")).append(APS.etaLabel),APS.content.append(b(APS.apBtn)).append(b(APS.hdgBtn)).append(b(APS.rteBtn)).append(b(APS.hptBtn)).append(e()).append(g).append(h).append(i).append(e()).append(j).append(k).append(l);var m=controls.autopilot;Log.info("Setting common climb rate to +500FT/MN"),m.commonClimbrate=500,Log.info("Setting common descent rate to -750FT/MN"),m.commonDescentrate=-750,Log.info("Setting max bank angle to 20DEG"),m.maxBankAngle=20,Log.info("Setting max climb rate to +2000FT/MN"),m.maxClimbrate=2e3,Log.info("Setting max descent rate to -1800FT/MN"),m.maxDescentrate=-1800,Log.info("Setting max pitch angle to 10DEG"),m.maxPitchAngle=10,Log.info("Setting min pitch angle to -8DEG"),m.minPitchAngle=-8,Log.info("Finished setting a less aggressive AP"),APS._hook(),SimpleFMC.registerUpdate(APS.update)},_initHoldPattern:function(){controls.autopilot.setHeading((controls.autopilot.heading+180)%360),APS._holdPatternCoord=[{lat:gefs.aircraft.llaLocation[0],lon:gefs.aircraft.llaLocation[1]}],APS._holdPatternTicks=0},turnOn:function(){if(gefs.aircraft.setup.autopilot){gefs.aircraft.animationValue;if(controls.autopilot.climbPID.reset(),controls.autopilot.pitchPID.reset(),controls.autopilot.rollPID.reset(),controls.autopilot.throttlePID.reset(),"HDG"===APS.mode){var a=parseInt(APS.hdgLabel.val());if(!isNaN(a)&&a>=0&&a<=360)controls.autopilot.setHeading(a%360);else{a=parseInt(gefs.aircraft.animationValue.heading360);var b=gefs.aircraft.animationValue.aroll;Math.abs(b)>=1&&(b>0?a-=8:a+=8),controls.autopilot.setHeading(a),APS.hdgLabel.val(a)}}else if("RTE"===APS.mode){null===RouteManager._currentWaypoint&&(Log.info("Current waypoint is NULL, getting next waypoint"),RouteManager.nextWaypoint());var c=RouteManager._currentWaypoint,d={lat:gefs.aircraft.llaLocation[0],lon:gefs.aircraft.llaLocation[1]};null!==c&&(Log.info("Got next waypoint: "+c.id),RouteManager._totalDist=Utils.getGreatCircleDistance(d,c),null!==c.altitude&&controls.autopilot.setAltitude(c.altitude),null!==c.ias&&controls.autopilot.setKias(c.ias))}else"HPT"===APS.mode&&APS._initHoldPattern();var e=parseInt(APS.iasLabel.val());!isNaN(e)&&e>0?controls.autopilot.setKias(e):(e=parseInt(gefs.aircraft.animationValue.kias),controls.autopilot.setKias(e),APS.iasLabel.val(e));var f=parseInt(APS.altLabel.val());if(isNaN(f)){f=parseInt(gefs.aircraft.animationValue.altitude);var g=gefs.aircraft.animationValue.climbrate;Math.abs(g)>=100&&(g>0?f+=500:f-=500),controls.autopilot.setAltitude(f),APS.altLabel.val(f)}else controls.autopilot.setAltitude(f);controls.autopilot.on=!0,ui.hud.autopilotIndicator(!0),Log.info("AP engaged, MODE="+APS.mode),APS.apBtn.text("AUTOPILOT\nENGAGED").css("border","1px solid #0f0").css("color","#0f0")}},turnOff:function(){controls.autopilot.on=!1,ui.hud.autopilotIndicator(!1),Log.info("AP disengaged"),APS.apBtn.text("AUTOPILOT\nDISENGAGED").css("border","1px solid #f00").css("color","#f00")},_hook:function(){controls.autopilot.turnOn=function(){APS.turnOn()},controls.autopilot.turnOff=function(){APS.turnOff()};var a=controls.autopilot.setAltitude,b=controls.autopilot.setHeading,c=controls.autopilot.setKias;controls.autopilot.setAltitude=function(b){return Log.info("AP: setting new altitude="+b+"ft"),a(b)},controls.autopilot.setHeading=function(a){return Log.info("AP: setting new heading="+a+"deg"),b(a)},controls.autopilot.setKias=function(a){return Log.info("AP: setting new kias="+a+"kts"),c(a)}},update:function(){if(controls.autopilot.on)if("RTE"===APS.mode)if(null===RouteManager._currentWaypoint)APS.hptBtn.click();else{var a={lat:gefs.aircraft.llaLocation[0],lon:gefs.aircraft.llaLocation[1]};RouteManager._distanceTilWaypoint=Utils.getGreatCircleDistance(a,RouteManager._currentWaypoint);var b=parseInt(Utils.getGreatCircleBearing(a,RouteManager._currentWaypoint));if(b!==controls.autopilot.heading&&controls.autopilot.setHeading(b),Math.abs(RouteManager._distanceTilWaypoint)<1){RouteManager.nextWaypoint();var c=RouteManager._currentWaypoint;null!==c&&(RouteManager._totalDist=Utils.getGreatCircleDistance(a,c),null!==c.altitude&&controls.autopilot.setAltitude(c.altitude),null!==c.ias&&controls.autopilot.setKias(c.ias))}else{var d=Math.abs(APS._lastDistance-RouteManager._distanceTilWaypoint);RouteManager._eta=parseInt(1/d*RouteManager._distanceTilWaypoint),APS._lastDistance=RouteManager._distanceTilWaypoint}APS.nextLabel.text(RouteManager._currentWaypoint.id),APS.distLabel.text(parseInt(100*RouteManager._distanceTilWaypoint)/100+"KM"),APS.etaLabel.text(Utils.getTimeStamp(1e3*RouteManager._eta))}else if("HPT"===APS.mode)if(1===APS._holdPatternCoord.length){var e=parseInt(gefs.aircraft.animationValue.heading360);e>=controls.autopilot.heading-3&&e<=controls.autopilot.heading+3?APS._holdPatternTicks>35?(APS._holdPatternCoord.push({lat:gefs.aircraft.llaLocation[0],lon:gefs.aircraft.llaLocation[1]}),APS._holdPatternTicks=0,Log.info("Target set for holding pattern")):APS._holdPatternTicks+=1:APS._holdPatternTicks=0}else if(2===APS._holdPatternCoord.length){var f={lat:gefs.aircraft.llaLocation[0],lon:gefs.aircraft.llaLocation[1]},g=APS._holdPatternCoord[APS._holdPatternTicks],h=Utils.getGreatCircleDistance(f,g),i=parseInt(Utils.getGreatCircleBearing(f,g));i!==controls.autopilot.heading&&controls.autopilot.setHeading(i),Math.abs(h)<1&&(0===APS._holdPatternTicks?APS._holdPatternTicks=1:APS._holdPatternTicks=0)}else Log.error("Holding pattern is in a bad state! Reinitializing..."),console.log(APS._holdPatternCoord),APS._initHoldPattern();gefs.aircraft.animationValue.kias>=400?(5!==controls.autopilot.maxPitchAngle&&(Log.info("Setting max pitch angle to 5DEG"),controls.autopilot.maxPitchAngle=5),controls.autopilot.minPitchAngle!==-5&&(Log.info("Setting min pitch angle to -5DEG"),controls.autopilot.minPitchAngle=-5)):(10!==controls.autopilot.maxPitchAngle&&(Log.info("Setting max pitch angle to 10DEG"),controls.autopilot.maxPitchAngle=10),controls.autopilot.minPitchAngle!==-8&&(Log.info("Setting min pitch angle to -8DEG"),controls.autopilot.minPitchAngle=-8)),controls.autopilot.on&&("HPT"===APS.mode?30!==controls.autopilot.maxBankAngle&&(Log.info("Setting max bank angle to 30DEG"),controls.autopilot.maxBankAngle=30):20!==controls.autopilot.maxBankAngle&&(Log.info("Setting max bank angle to 20DEG"),controls.autopilot.maxBankAngle=20))}},SimpleFMC={timerID:null,updateFnList:[],init:function(){Log.init(UI.logContainer),Status.init(UI.statusContainer),APS.init(UI.apsContainer),Route.init(UI.routeContainer),Info.init(UI.infoContainer),SimpleFMC.timerID=setInterval(SimpleFMC.backgroundUpdate,1e3),"mouse"!==controls.mode||controls.mixYawRoll||(Log.info("Detected mouse mode with mixYawRoll off, applying fixes..."),controls.yawExponential="0.0"),Log.info("SimpleFMC initialized and ready to go.")},registerUpdate:function(a){SimpleFMC.updateFnList.push(a)},backgroundUpdate:function(){for(var a=0;a<SimpleFMC.updateFnList.length;a++)SimpleFMC.updateFnList[a]()},fini:function(){null!==SimpleFMC.timerID&&clearInterval(SimpleFMC.timerID)}},BANNER=" _____  _                    _       ______ ___  ___ _____  \n/  ___|(_)                  | |      |  ___||  \\/  |/  __ \\ \n\\ `--.  _  _ __ ___   _ __  | |  ___ | |_   | .  . || /  \\/ \n `--. \\| || '_ ` _ \\ | '_ \\ | | / _ \\|  _|  | |\\/| || |     \n/\\__/ /| || | | | | || |_) || ||  __/| |    | |  | || \\__/\\ \n\\____/ |_||_| |_| |_|| .__/ |_| \\___|\\_|    \\_|  |_/ \\____/ \n                     | |                                    \n                     |_|                                    \n",Info={content:null,_uptime:null,_aircraft:null,_mass:null,init:function(a){Info.content=a;var b=$("<pre></pre>");b.text(BANNER).css("margin-left","5px").css("line-height","1").css("font-size","8pt"),Info._aircraft=$("<span></span>"),Info._uptime=$("<span></span>"),Info._mass=$("<span></span>");var c=$("<span></span>");c.text("ASCII ART GENERATED BY ").append($('<a href="http://patorjk.com/software/taag">TaaG</a>'));var d=$("<div></div>");d.css("margin-left","5px").text("AIRCRAFT: ").append(Info._aircraft).append($("<br>")).append("WEIGHT: ").append(Info._mass).append($("<br>")).append("UPTIME: ").append(Info._uptime).append($("<br><br>")).append(c),Info.content.append(b).append(d),SimpleFMC.registerUpdate(Info.update)},update:function(){Info._aircraft.text(gefs.aircraft.name),Info._uptime.text(Log.uptime()),Info._mass.text(gefs.aircraft.rigidBody.mass+"KG")}},Log={content:null,startTime:null,init:function(a){Log.content=a,Log.content.css("overflow-y","scroll").css("overflow-x","auto").css("line-height","1.3").css("height","290px"),Log.startTime=Date.now()},info:function(a){Log._write(Log._entry("#9be651",a))},warning:function(a){Log._write(Log._entry("#ffc300",a))},error:function(a){Log._write(Log._entry("#d14537",a))},clear:function(){Log.content.empty()},uptime:function(){return Utils.getTimeStamp(Date.now()-Log.startTime)},_entry:function(a,b){var c=$("<div></div>"),d=$("<span></span>");d.css("color","#0f0").css("font-size","8pt").css("margin-right","4px").text("["+Log.uptime()+"]");var e=$("<span></span>");return e.css("color",a).text(b),c.append(d).append(e),c},_write:function(a){Log.content.prepend(a)}};!function(){"use strict";var a=function(){UI.init(),SimpleFMC.init()},b=setInterval(function(){if(window.gefs&&gefs.init)if(clearInterval(b),gefs.canvas)a();else{var c=gefs.init;gefs.init=function(){c(),a()}}},16)}();var RouteManager={_list:null,_routesList:[],_uiList:[],_currentWaypoint:null,_waypointIndex:-1,_distanceTilWaypoint:0,_eta:0,_totalDist:0,init:function(a){RouteManager._list=$("<div></div>"),RouteManager._list.css("width","calc(50% - 4px)").css("height","286px").css("float","left").css("padding","2px").css("overflow-y","scroll"),a.append(RouteManager._list)},_lookupId:function(a){var b=a.toUpperCase(),c=LOCATION_DB.fixes[b];return void 0!==c?c:(c=LOCATION_DB.airports[b],void 0!==c?c:(c=LOCATION_DB.navaids[b],void 0!==c?c:null))},_parseDirective:function(a){var b={ok:!1,msg:"",data:null},c=a.indexOf("@"),d=a.indexOf(":"),e={id:null,altitude:null,ias:null,lat:null,lon:null};c===-1&&d===-1?e.id=a:c===-1?(e.id=a.slice(0,d),e.ias=parseInt(a.slice(d+1))):d===-1?(e.id=a.slice(0,c),e.altitude=parseInt(a.slice(c+1))):(c>d?e.id=a.slice(0,d):e.id=a.slice(0,c),e.altitude=parseInt(a.slice(c+1)),e.ias=parseInt(a.slice(d+1)));var f=RouteManager._lookupId(e.id);return null===f?(b.msg="Invalid waypoint: "+e.id,b):isNaN(e.altitude)?(b.msg="Invalid altitude for waypoint: "+e.id,b):isNaN(e.ias)?(b.msg="Invalid IAS for waypoint: "+e.id,b):(e.lat=f.lat,e.lon=f.lon,b.ok=!0,b.data=e,b)},load:function(a){for(var b={ok:!1,msg:""},c=[],d=0;d<a.length;d++){var e=RouteManager._parseDirective(a[d]);if(!e.ok)return b.msg=e.msg,b;c.push(e.data)}var f=0,g={lat:gefs.aircraft.llaLocation[0],lon:gefs.aircraft.llaLocation[1]};for(d=0;d<c.length;d++)RouteManager._add(c[d]),f+=Utils.getGreatCircleDistance(g,c[d]),g=c[d];var h=$("<div></div>");return h.text("ADDED "+RouteManager._routesList.length+" WAYPOINTS").append($("<br>")).append("TOTAL DISTANCE:"+parseInt(100*f)/100+"KM"),Route._info.empty().append(h),b.ok=!0,b},_add:function(a){var b=$("<div></div>");b.css("margin-top","1px").css("margin-bottom","1px").css("padding","2px").css("background","#555").css("width","calc(100% - 5px)").css("height","40px");var c=$("<span></span>");if(c.css("font-size","12pt").css("color","#0f0").css("float","left").text(a.id),b.append(c),null!==a.altitude){var d=$("<span></span>");d.css("color","#0f0").css("float","right").text(a.altitude+"FT"),b.append(d)}if(null!==a.ias){var e=$("<span></span>");e.css("color","#0f0").css("float","right").css("padding-left","10px").text(a.ias+"KTS"),b.append(e)}RouteManager._list.append(b),RouteManager._uiList.push(b),RouteManager._routesList.push(a)},_clear:function(){RouteManager._currentWaypoint=null,RouteManager._waypointIndex=-1,RouteManager._distanceTilWaypoint=0,RouteManager._eta=0,RouteManager._totalDist=0,RouteManager._list.empty(),Route._info.empty(),RouteManager._routesList=[],RouteManager._uiList=[]},nextWaypoint:function(){console.log(RouteManager),RouteManager._waypointIndex>=0&&RouteManager._uiList[RouteManager._waypointIndex].css("background","#111");var a=RouteManager._routesList[RouteManager._waypointIndex+1];void 0===a?RouteManager._currentWaypoint=null:(RouteManager._uiList[RouteManager._waypointIndex+1].css("background","#777"),RouteManager._currentWaypoint=a,RouteManager._waypointIndex++,Log.info("Next waypoint: "+RouteManager._currentWaypoint.id))},reset:function(){RouteManager._clear()}},Route={content:null,_dialog:null,_routeEntry:null,_submitRoute:null,_status:null,_info:null,_details:null,init:function(a){Route.content=a,RouteManager.init(a),Route._setupMainDialog(),Route._setupRouteDialog(),Route.content.append(RouteManager._list).append(Route._details).append(Route._dialog)},_setupMainDialog:function(){Route._details=$("<div></div>"),Route._details.css("width","calc(50% - 4px)").css("height","286px").css("float","left").css("padding","2px"),Route._info=$("<div></div>"),Route._info.css("width","100%").css("height","90%").text("PRESS LOAD TO DEFINE A ROUTE TO FOLLOW");var a=$("<div></div>");a.css("width","100%").css("height","10%").css("text-align","center").css("margin-left","3px");var b=$("<button></button>");b.text("LOAD").css("padding","0px").css("margin","0px").css("height","100%").css("width","33%").css("background","#333").css("border","1px solid #0f0").css("color","#0f0").click(function(){RouteManager._list.css("display","none"),Route._details.css("display","none"),Route._dialog.show()});var c=$("<button></button>");c.text("ACTV").css("padding","0px").css("margin","0px").css("height","100%").css("width","33%").css("background","#333").css("border","1px solid #0f0").css("color","#0f0").click(function(){RouteManager.nextWaypoint();var b={lat:gefs.aircraft.llaLocation[0],lon:gefs.aircraft.llaLocation[1]},c=RouteManager._currentWaypoint;null!==c&&(Log.info("Current waypoint: "+RouteManager._currentWaypoint.id),RouteManager._totalDist=Utils.getGreatCircleDistance(b,c),null!==c.altitude&&a.autopilot.setAltitude(c.altitude),null!==c.ias&&a.autopilot.setKias(c.ias),APS.rteBtn.click())});var d=$("<button></button>");d.text("RESET").css("padding","0px").css("margin","0px").css("height","100%").css("width","33%").css("background","#333").css("border","1px solid #0f0").css("color","#0f0").click(function(){RouteManager.reset()}),a.append(b).append(c).append(d),Route._details.append(Route._info).append(a)},_setupRouteDialog:function(){Route._dialog=$("<div></div>"),Route._dialog.css("display","none");var a=$("<div></div>");a.css("height","20px").text("Enter route information as specified by ").append($('<a href="https://github.com/andermatt64/simple-fmc-gefs-plugin/blob/master/ROUTES.md">ROUTES.md</a>')),Route._status=$("<div></div>"),Route._status.css("height","80px").css("color","#f00"),Route._routeEntry=$("<textarea></textarea>"),Route._routeEntry.css("width","calc(100% - 5px)").css("height","150px").css("background","#555").css("color","#0f9").css("border","1px solid #0f0").css("margin","0px").css("font-family","Lucida Console, Monaco, monospace").css("font-size","8pt").keyup(function(a){a.stopImmediatePropagation()}),Route._submitRoute=$("<button></button>"),Route._submitRoute.text("SUBMIT").css("border","1px solid #0f0").css("background","#333").css("color","#0f0").css("margin","0px").css("width","50%").css("text-align","center").click(function(){var a=Route._routeEntry.val();if(0===a.length)return void Route._status.text("ERROR: Empty entry box!");var b=a.split(" ");if(0===b.length)return void Route._status.text("ERROR: Entry is not valid");for(var c=[],d=0;d<b.length;d++)b[d].length>0&&c.push(b[d]);if(0===c.length)return void Route._status.text("ERROR: Invalid list format!");var e=RouteManager.load(c);return e.ok?(Route._routeEntry.text(""),Route._status.text(""),void Route._dialog.fadeOut(function(){RouteManager._list.css("display","block"),Route._details.css("display","block")})):void Route._status.text("ERROR: "+e.msg)});var b=$("<button></button>");b.text("CANCEL").css("border","1px solid #0f0").css("background","#333").css("color","#0f0").css("margin","0px").css("width","50%").css("text-align","center").click(function(){Route._dialog.fadeOut(function(){RouteManager._list.css("display","block"),Route._details.css("display","block")})}),Route._dialog.append(a).append(Route._status).append(Route._routeEntry).append(b).append(Route._submitRoute)}},makeStatusPanel=function(){var a=$("<div></div>");return a.css("width","25%").css("height","100px").css("float","left"),a},NextWaypoint={_panel:null,_fill:null,_time:null,_target:null,init:function(a){NextWaypoint._panel=makeStatusPanel();var b=$("<div></div>");b.css("margin-top","5px").css("margin-bottom","5px").css("margin-left","5px").css("border","1px solid #0f0").css("width","10px").css("height","80px").css("background","#0f0").css("float","left"),NextWaypoint._fill=$("<div></div>"),NextWaypoint._fill.css("background","#000").css("height","100%");var c=$("<div></div>");c.css("padding-top","5px").css("padding-left","5px").css("color","#0f0").css("float","left"),NextWaypoint._time=$("<span></span>"),NextWaypoint._target=$("<span></span>"),c.text("NEXT WPT").append($("<br>")).append(NextWaypoint._target).append($("<br>")).append("ETA").append($("<br>")).append(NextWaypoint._time),b.append(NextWaypoint._fill),NextWaypoint._panel.append(b).append(c),a.append(NextWaypoint._panel)},update:function(){var a=RouteManager._currentWaypoint;if(null!==a){var b=parseInt(RouteManager._distanceTilWaypoint/RouteManager._totalDist*100);NextWaypoint._fill.css("height",(100-Math.abs(b)).toString()+"%"),NextWaypoint._target.text(a.id),NextWaypoint._time.text(Utils.getTimeStamp(1e3*RouteManager._eta))}}},ElevatorTrim={_panel:null,_fill:null,_trim:null,_mach:null,init:function(a){ElevatorTrim._panel=makeStatusPanel();var b=$("<div></div>");b.css("margin-top","5px").css("margin-bottom","5px").css("margin-left","5px").css("border","1px solid #0f0").css("width","10px").css("height","80px").css("background","#0f0").css("float","left"),ElevatorTrim._fill=$("<div></div>"),ElevatorTrim._fill.css("background","#000").css("height","100%");var c=$("<div></div>");c.css("padding-top","5px").css("padding-left","5px").css("color","#0f0").css("float","left"),ElevatorTrim._trim=$("<span></span>"),ElevatorTrim._mach=$("<span></span>"),c.text("ELVTRIM").append($("<br>")).append(ElevatorTrim._trim).append($("<br>")).append("MACH").append($("<br>")).append(ElevatorTrim._mach),b.append(ElevatorTrim._fill),ElevatorTrim._panel.append(b).append(c),a.append(ElevatorTrim._panel)},update:function(a,b){var c=parseInt(100*(a+.5));ElevatorTrim._fill.css("height",(100-Math.abs(c)).toString()+"%"),ElevatorTrim._trim.text((parseInt(1e3*a)/1e3).toString()),b=parseInt(1e3*b)/1e3,ElevatorTrim._mach.text(b.toString())}},APStatus={_panel:null,_label:null,_mode:null,init:function(a){APStatus._panel=makeStatusPanel();var b=$("<div></div>");b.css("margin-left","5px").css("margin-top","5px"),APStatus._label=$("<span></span>"),APStatus._mode=$("<span></span>"),b.text("AP STAT").append($("<br>")).append(APStatus._label).append($("<br>")).append("AP MODE").append($("<br>")).append(APStatus._mode),APStatus._panel.append(b),a.append(APStatus._panel)},update:function(a,b){a?APStatus._label.text("ON").css("color","#339966"):APStatus._label.text("OFF").css("color","#ff3300"),APStatus._mode.text(b)}},Brakes={_panel:null,_airbrake:null,_brake:null,init:function(a){Brakes._panel=makeStatusPanel();var b=$("<div></div>");b.css("margin-left","5px").css("margin-top","5px"),Brakes._airbrake=$("<span></span>"),Brakes._brake=$("<span></span>"),b.text("SPOILER").append($("<br>")).append(Brakes._airbrake).append($("<br>")).append("BRAKES").append($("<br>")).append(Brakes._brake),Brakes._panel.append(b),a.append(Brakes._panel)},update:function(a,b){0===a?Brakes._airbrake.text("DISARM").css("color","#339966"):1===a?Brakes._airbrake.text("ARM").css("color","#ff3300"):Brakes._airbrake.text("CHNG").css("color","#ff9933"),0===b?Brakes._brake.text("OFF").css("color","#339966"):Brakes._brake.text("ON").css("color","#ff3300")}},AltitudeAndClimbRate={_panel:null,_altitudeLabel:null,_climbRateLabel:null,init:function(a){AltitudeAndClimbRate._panel=makeStatusPanel();var b=$("<div></div>");b.css("margin-left","5px").css("margin-top","5px"),AltitudeAndClimbRate._altitudeLabel=$("<span></span>"),AltitudeAndClimbRate._climbRateLabel=$("<span></span>"),b.text("ALTITUDE").append($("<br>")).append(AltitudeAndClimbRate._altitudeLabel).append($("<br>")).append("VERTSPD").append($("<br>")).append(AltitudeAndClimbRate._climbRateLabel),AltitudeAndClimbRate._panel.append(b),a.append(AltitudeAndClimbRate._panel)},update:function(a,b){a=parseInt(a).toString(),b=parseInt(b).toString(),AltitudeAndClimbRate._altitudeLabel.text(a+"FT"),AltitudeAndClimbRate._climbRateLabel.text(b+"FT/M")}},HeadingAndSpeed={_panel:null,_headingLabel:null,_speedLabel:null,init:function(a){HeadingAndSpeed._panel=makeStatusPanel();var b=$("<div></div>");b.css("margin-left","5px").css("margin-top","5px"),HeadingAndSpeed._headingLabel=$("<span></span>"),HeadingAndSpeed._speedLabel=$("<span></span>"),b.text("HEADING").append($("<br>")).append(HeadingAndSpeed._headingLabel).append($("<br>")).append("KIAS").append($("<br>")).append(HeadingAndSpeed._speedLabel),HeadingAndSpeed._panel.append(b),a.append(HeadingAndSpeed._panel)},update:function(a,b){a=parseInt(a).toString(),b=parseInt(b).toString(),HeadingAndSpeed._headingLabel.text(a+"DEG"),HeadingAndSpeed._speedLabel.text(b+"KTS")}},FlapsAndGear={_panel:null,_fill:null,_flapLabel:null,_gearLabel:null,init:function(a){FlapsAndGear._panel=makeStatusPanel();var b=$("<div></div>");b.css("margin-top","5px").css("margin-bottom","5px").css("margin-left","5px").css("border","1px solid #0f0").css("width","10px").css("height","80px").css("background","#0f0").css("float","left"),FlapsAndGear._fill=$("<div></div>"),FlapsAndGear._fill.css("background","#000").css("height","100%");var c=$("<div></div>");c.css("padding-top","5px").css("padding-left","5px").css("color","#0f0").css("float","left"),FlapsAndGear._flapLabel=$("<span></span>"),FlapsAndGear._gearLabel=$("<span></span>"),c.text("FLAPS").append($("<br>")).append(FlapsAndGear._flapLabel).append($("<br>")).append("GEAR").append($("<br>")).append(FlapsAndGear._gearLabel),b.append(FlapsAndGear._fill),FlapsAndGear._panel.append(b).append(c),a.append(FlapsAndGear._panel)},update:function(a,b){var c=parseInt(100*a);FlapsAndGear._fill.css("height",(100-Math.abs(c)).toString()+"%");var d=c.toString();1===d.length?d="00"+d:2===d.length&&(d="0"+d),FlapsAndGear._flapLabel.text(d+"/100"),0===b?FlapsAndGear._gearLabel.text("DOWN").css("color","#339966"):1===b?FlapsAndGear._gearLabel.text("UP").css("color","#ff3300"):FlapsAndGear._gearLabel.text("CHNG").css("color","#ff9933")}},Throttle={_panel:null,_fill:null,_label:null,_engine:null,_meter:null,init:function(a){Throttle._panel=makeStatusPanel(),Throttle._meter=$("<div></div>"),Throttle._meter.css("margin-top","5px").css("margin-bottom","5px").css("margin-left","5px").css("border","1px solid #0f0").css("width","10px").css("height","80px").css("background","#0f0").css("float","left"),Throttle._fill=$("<div></div>"),Throttle._fill.css("background","#000").css("height","100%");var b=$("<div></div>");b.css("padding-top","5px").css("padding-left","5px").css("color","#0f0").css("float","left"),Throttle._label=$("<span></span>"),Throttle._engine=$("<span></span>"),b.text("THROT").append($("<br>")).append(Throttle._label).append($("<br>")).append("ENGINE").append($("<br>")).append(Throttle._engine),Throttle._meter.append(Throttle._fill),Throttle._panel.append(Throttle._meter).append(b),a.append(Throttle._panel)},update:function(a,b){var c=parseInt(100*a);Throttle._fill.css("height",(100-Math.abs(c)).toString()+"%"),c<0?(c=-c,Throttle._meter.css("background","#ff8400"),Throttle._label.css("color","#ff8400")):(Throttle._meter.css("background","#0f0"),Throttle._label.css("color","#0f0"));var d=c.toString();1===d.length?d="00"+d:2===d.length&&(d="0"+d),Throttle._label.text(d+"/100"),b?Throttle._engine.css("color","#339966").text("ON"):Throttle._engine.css("color","#ff3300").text("OFF")}},Status={content:null,init:function(a){Status.content=a,Throttle.init(a),HeadingAndSpeed.init(a),AltitudeAndClimbRate.init(a),NextWaypoint.init(a),FlapsAndGear.init(a),ElevatorTrim.init(a),Brakes.init(a),APStatus.init(a),SimpleFMC.registerUpdate(function(){Throttle.update(gefs.aircraft.animationValue.throttle,gefs.aircraft.engine.on),HeadingAndSpeed.update(gefs.aircraft.animationValue.heading360,gefs.aircraft.animationValue.kias),AltitudeAndClimbRate.update(gefs.aircraft.animationValue.altitude,gefs.aircraft.animationValue.climbrate),NextWaypoint.update(),FlapsAndGear.update(gefs.aircraft.animationValue.flapsValue,gefs.aircraft.animationValue.gearPosition),ElevatorTrim.update(gefs.aircraft.animationValue.trim,gefs.aircraft.animationValue.mach),Brakes.update(gefs.aircraft.animationValue.airbrakesPosition,gefs.aircraft.animationValue.brakes),APStatus.update(controls.autopilot.on,APS.mode)})}},UI={FmcHeight:"300px",infoContainer:null,statusContainer:null,apsContainer:null,routeContainer:null,logContainer:null,_state:{active:null},init:function(){$(".gefs-map-list").css("border-bottom",UI.FmcHeight+" solid transparent");var a=$(".gefs-autopilot");a.empty().css("height",UI.FmcHeight).css("font-family","Lucida Console, Monaco, monospace").css("font-size","9pt").css("background","#555555").css("padding","0 0 0 0");var b=function(a,b){var c=$("<button></button>");return c.text(a).css("width","100%").css("font-family","Lucida Console, Monaco, monospace").css("font-weight","bold").css("font-size","8pt").css("text-align","left").css("transition-duration","0.4s").css("border-top","1px solid #000").css("border-left","1px solid #000"),void 0!==b&&b&&c.css("border-bottom","1px solid #000"),c},c=$("<div></div>");c.css("float","left").css("width","10%").css("margin-right","0px").css("padding-right","0px");var d=$("<div></div>");d.css("float","left").css("background","#000").css("color","#0f0").css("width","90%").css("height","300px").css("margin-right","0px").css("padding-right","0px"),UI.infoContainer=$("<div></div>"),UI.infoContainer.css("padding","5px"),UI.statusContainer=$("<div></div>"),UI.statusContainer.css("display","none").css("padding","5px"),UI.apsContainer=$("<div></div>"),UI.apsContainer.css("display","none").css("padding","5px"),UI.routeContainer=$("<div></div>"),UI.routeContainer.css("display","none").css("padding","5px"),UI.logContainer=$("<div></div>"),UI.logContainer.css("display","none").css("padding","5px"),UI._state.active=UI.infoContainer;var e=b("INFO"),f=b("STAT"),g=b("APS"),h=b("RTE"),i=b("LOG",!0);e.click(function(){UI._state.active!==UI.infoContainer&&UI._state.active.fadeOut(function(){UI.infoContainer.fadeIn(function(){UI._state.active=UI.infoContainer})})}),f.click(function(){UI._state.active!==UI.statusContainer&&UI._state.active.fadeOut(function(){UI.statusContainer.fadeIn(function(){UI._state.active=UI.statusContainer})})}),g.click(function(){UI._state.active!==UI.apsContainer&&UI._state.active.fadeOut(function(){UI.apsContainer.fadeIn(function(){UI._state.active=UI.apsContainer})})}),h.click(function(){UI._state.active!==UI.routeContainer&&UI._state.active.fadeOut(function(){UI.routeContainer.fadeIn(function(){UI._state.active=UI.routeContainer})})}),i.click(function(){UI._state.active!==UI.logContainer&&UI._state.active.fadeOut(function(){UI.logContainer.fadeIn(function(){UI._state.active=UI.logContainer})})}),d.append(UI.infoContainer),d.append(UI.statusContainer),d.append(UI.apsContainer),d.append(UI.routeContainer),d.append(UI.logContainer),c.append(e).append(f).append(g).append(h).append(i),a.append(c).append(d)}},Utils={toRadians:function(a){return a*(Math.PI/180)},toDegrees:function(a){return a*(180/Math.PI)},getGreatCircleBearing:function(a,b){var c=Utils.toRadians(a.lat),d=Utils.toRadians(a.lon),e=Utils.toRadians(b.lat),f=Utils.toRadians(b.lon),g=Math.sin(f-d)*Math.cos(e),h=Math.cos(c)*Math.sin(e)-Math.sin(c)*Math.cos(e)*Math.cos(f-d),i=Math.atan2(g,h);return(Utils.toDegrees(i)+360)%360},getGreatCircleDistance:function(a,b){var c=6371e3,d=Utils.toRadians(a.lat),e=Utils.toRadians(b.lat),f=Utils.toRadians(b.lat-a.lat),g=Utils.toRadians(b.lon-a.lon),h=Math.sin(f/2)*Math.sin(f/2)+Math.cos(d)*Math.cos(e)*Math.sin(g/2)*Math.sin(g/2),i=2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)),j=c*i;
return j/1e3},getTimeStamp:function(a){var b=parseInt(a/1e3),c=parseInt(b/3600).toString();1===c.length&&(c="0"+c);var d=parseInt(b%3600/60).toString();1===d.length&&(d="0"+d);var e=parseInt(b%3600%60).toString();return 1===e.length&&(e="0"+e),c+":"+d+":"+e}};